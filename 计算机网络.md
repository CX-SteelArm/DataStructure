## 计算机网络

-------------

计算机网络相关总结
重点：每一层的相关设备、协议和算法

重点概念

拓扑：

    信道的分布方式，有总线型、星型、环形、树形和全联通/网状等
    互联网中主要用到总线型和星型来连接

OSI模型：

    Application 提供服务
    Presentation 数据的解释，解密加密等
    Session 保证会话连接
    Transport 端到端的连接
    Network 选择最优路径，点到点的连接
    Data Link 物理寻址，网络拓扑，错误提示，流控
    Physical 只负责传输2进制比特流

TCP/IP四层模型：

    Application
    Transport
    Internet
    Network Access

### 物理层
提供透明的比特流传输

带宽

    物理带宽vs数字带宽
    奈奎斯特定理 -- 在无噪声信道中，当频率为B，以每秒高于2B次的速率对线路采样是无意义的
    香农定理 -- 在有噪声信道中，频率为B Hz，信噪比为S/N时，最大传输速率为Blog2(1+S/N) bps
    噪声分贝值与信噪比的换算：db = 10log10(S/N)

**设备**


    引导性传输介质：主要有铜线和光纤  同轴电缆  双绞线
    非引导性传输介质：卫星、无线电等
    收发器(transceiver):是transmitter和reciver的简称，将一种形式的信号转化为另一种形式
    中继器(repeater)：信号再生，不可过滤
    集线器(hub)： 多端口的中继器，放大和再生信号，不可过滤

复用技术

    FDM(frequency division multiplexing) 正交FDM(orthogonal FDM)实现了复用，用在802.11，4G
    TDM(time division multiplexing) 用户轮流使用通道，用于telephone/cellular
    CDMA(code division multiple address)码分多址/扩展频谱  用于3G 码片正交

调制技术

    baseband transmission(基带传输)--直接将数据比特转化为信号
    passband transmission(通带传输)通过调节信号的振幅、相位和频率来传输信号
    基带传输方法：不归零逆转(比特时间内跳转为1),曼彻斯特编码,4B/5B跳转
    波特率是1s时间内传输的码元个数，也叫作码率
    比特率与波特率：C = Blog2(n) n表示电平数(允许的状态数)

### 数据链路层
为网络层提供良好的服务接口，保证数据传输的有效、可靠性，处理传输错误，进行流量控制

成帧方法
  
    字节填充的标志字节法：缺点是依赖于8位字节，而且容易在帧界造成混淆
    比特填充的标志比特法：以01111110作为帧开头，5个1补个0
    物理层编码违例法：采用冗余编码技术(使用调制技术中额外空闲的状态表示帧界)

纠错与检错

    海明距离是两个码字不同位的个数，如100001 和 111111 的海明距离为4
    海明距离与检错：海明距离d+1的编码能检出d位错误
    海明距离与纠错：海明距离为2d+1的编码，只能纠正d位差错
    纠一位错的海明码：冗余位个数r和数据位长度m之间满足 (m + r + 1 <= 2^r)
    检验位位于编号为2的整数次幂处，如1、2、4、8、16...位,进行的都是奇校验或偶校验
    * 循环冗余校验、互联网校验

**设备**
    

    * 网卡
    提供命名、成帧、Mac等功能
    * 交换机（网桥）
    存储转发  帧全部存储、进行校验之后转发，可靠性高但速度慢
    直通交换(贯穿)  读取到目的地址后直接转发，可靠性低
    无分片交换  读取64Byte即转发，消除了碎片帧的影响，提高了准确性

  
**基本协议**


    1. 无限制单工协议 
    2. 单工停-等协议
    解决了要求缓存空间无限大的假设
    解决方案：接收方收到帧后返回一个哑帧，此时发送下一帧
    3. 有噪声(错误)信道的单工协议
    采用了定时器防止丢帧死锁
    设置了一个定时器，如果在结束之前收到确认帧，则没有问题，否则重新发送帧
    对每一个帧确定了唯一序列号，防止重复处理帧

**滑窗协议**


    - 发送窗口(对应发送消息还未确认的帧的序号)
      接收窗口(对应着期望接受的帧的序号)

    - 信道利用率：k/(k+bR) k:每帧大小 b:传输速率 R:双程延迟时间
      位序列号只有0和1,信道利用率不高
      如果增加滑动窗口大小到W，则利用率变为W倍
      
    - 带宽延迟积：BD = 传输速率 * 单程延迟时间
      窗口值W <= 2*BD/k + 1

滑窗错误处理

    - 回退n帧
      发送窗口为n，接收窗口为1
      接收方策略：丢弃错帧，后续帧也丢弃
      发送方策略：将发送帧缓存起来，重发出错帧及之后的帧
    - 选择性重传
      发送方只重传差错帧
      接收方接收重传帧，按正确顺序提交给网络层

**MAC(media access control)子层**


    ALOHA协议、CSMA协议、CSMA/CD协议(以太网采用)
    - ALOHA工作原理：
    任何一个站点都在帧生成后立即发送，并通过信号的反馈检测信道，已确定是否发送成功
    如果发送失败，在随机延迟后再次发送
    冲突危险期为2个帧时(首尾相冲，浪费2个帧时)
    信道利用率 S 最大为18.6%(1/e/e),此时 G(网络负载) 为50%

    - 分隙ALOHA协议:
    分隙是将时间分为时隙(时间片)，帧的发送必须在时隙的开始
    冲突只会浪费一个帧时t
    信道利用率 S 最大为36.8%(1/e)，此时 G 为100%

    - CSMA协议(carrier sense multiple access)
    非持续式：等待随机事件重传
    1-持续：开始时保持持续侦听，介质空闲立即发送
    p-持续：开始时保持持续侦听，介质空闲以p概率发送

    - CSMA/CD协议
    1. 工作站同时接收自己的信号，如果和发送的不一致则表明冲突
    2. 冲突后立即停止发送，并发送一个简短的jam阻塞信号

**以太网**
    

    以太网包括了物理层和数据链路层
    使用CSMA/CD协议和二进制指数后退算法
    二进制指数后退算法：
    冲突后的等待时间：时隙为51.2μs，第i次冲突，等待的间隔从(0~2^i-1)*51.2μs中随机选择
    优化方法：把成功发送后的第一个时隙留给接收方，防止确认帧冲突
    使用交换机(switch)取代和集线器(hub)成为星型拓扑的中心节点
    干线上仍使用总线拓扑

帧结构

    先导字段 + 帧开始标记 + 目的地址 + 源地址 + 数据长度 + 数据 + 校验和
    62bit         xx        6Byte    6Byte    2Byte            4B
    802.3帧开始标记为11 数据长度46~1500B
    以太网帧开始标记为10 长度64字节，不足则填充

**二层交换**


    - 当一个帧到达网桥，它必须做出丢弃(discard)或者转发(forward)的决策
      决策是通过网桥内部一张MAC地址表查找得到的

    - 当一帧到达时，网桥启动如下算法：
      如果源Mac和目的Mac相同，丢弃这一帧
      如果源Mac和目的Mac不同，转发这一帧
      如果目的Mac未知，广播该帧
      每一帧到达，上述算法均执行一次

    - 网桥初始MAC地址表是空的
      通过泛洪算法将帧从除来的LAN的所有LAN转发出去
      逆向学习 学习帧来的那个LAN,将其写入MAC地址表
      无论何时,凡是往MAC表中输入记录,都打上时间戳
      到达帧的源地址在表中已有记录，则更新时间戳
      网桥周期性地扫描表，将超时的记录删除

**生成树协议(Spanning tree protocol)**


    一个LAN由多个网桥转发出去，可以应对单点故障的问题
    环路造成的问题广播风暴，所以用生成树协议生成逻辑上的无环路
    STP的运作原理：
    * 每个网络有一个根网桥
    * 每个网桥有一个根端口
    * 每个网段有一个指定端口
    * 非指定端口不被使用，但是会保持侦听，如果某个指定端口出现故障，非指定端口将被启用

VLAN

    隔离广播域和冲突域
    实现：基于端口(最常用)，基于三层协议，基于MAC地址

### 网络层
网络层需要封装源数据、找到目的机并找到一根好的路径(路由)

IPV4报头部分

|内容|大小|说明|
|:--:|:--:|:--:|
|协议版本|4bit|IPV4:0100 IPV6:0110|
|报头长度|4bit|以32bit为单位|
|服务类型|8bit|上层协议表明该分组的重要程度|
|数据报总长度|16bit|单位为字节|
|数据报标识号|16bit|当前分组的序列号，以便收方重组|
|标志/分片偏移|3bit/13bit|分组的分片号，以便收方重组|
|生存时间|8bit|Time To Live，一个计数器，TTL-1=0时分组被丢弃|
|用户协议|8bit|UDP:17 TCP:6|
|报头校验和|16bit|针对报头计算的互联网校验和，验证头部正确性|
|源点IP地址|32bit||
|目的点IP地址|32bit||
|数据报选项+填充|4byte的整数倍|不常用|

IPV6报头部分

|内容|大小|说明|
|:--:|:--:|:--:|
|协议版本|4bit|IPV4:0100 IPV6:0110|
|业务等级|8bit|分组的重要程度|
|流标记|20bit|流标签可用来标记特定流的报文|
|净荷长度|16bit||
|下一个头|8bit|扩展头，如果没有，为17/6 UDP/TCP|
|跳数限制|8bit||
|source|128bit|源IP|
|destination|128bit|目的IP|

**设备**
    
    - 路由器
    - 三层交换机

路由表

    - 路由器的动作：1.打开分组提取IP 2.查找路由表，AND操作 3.重新封装，转发
    - 路由表的由来：直连路由、静态路由、动态路由
    dos中输入 route print 可以看到主机路由表（静态）
    动态路由动态地建立、更新和维护的路由，适合大型的、经常变动的网络
    - 度量值：路径长度、可靠性、延迟、带宽、负载、通信价格

路由选择协议

    - 最优化原理：如果router J在I到K的最优路径上，则J到K的最优路径也同样在这条路径上

    - 沉落树(sink tree):从所有目的到源的最优路径形成的树，树根是源

    - DV 用于小型网络，维持D和V向量，D表示距离，V表示下一跳
    DV特点：简单，信息交流慢，收敛慢

    - RIP 路由信息协议是典型的DV协议，以跳数作为度量，(<15hop, 30s/exchange)
    RIP会形成路由环，可以通过水平分割、毒性逆转等

    - LS 用于大型网络
    发现 - 它的邻居节点们，了解它们的网络地址（发送HELLO，包含名字）
    设置 - 到它的每个邻居的成本度量（发送ECHO分组，通过应答间隔确定延迟）
    构造 - 一个分组，包含它所了解到的所有信息（周期性构造或者当特定事件(例如某个路由器down掉)发生时）
    发送 - 这个分组给所有其他的路由器（router记录下看到的源-序列号对）
    计算 - 到每个路由器的最短路径（使用dijkstra等算法求算最短路径）
    LS特点：每个路由器认识一致，收敛快，路由器计算和存储负担大

    - 单区域OSPF(open shortest path first)
    使用带宽作为度量值、应用广泛、无路由子环
    必须划分区域，所有子区域连接到骨干区域上
    通过选举DR和BDR将路由器之间通信的拓扑关系变为星型
    OSPF在每一条LSA中标记了生成者，克服了路由环

IP相关技术

    - 子网规划
    * 局域网不断增长，越来越难于管理，必须将其划分为子网
    * 一个网络被划分为几个部分(子网),但从外部看来是一个整体(体现在路由器的路由表例上,外部的路由器只对应一条路由)
    * 主路由器(边界路由器)维护一张子网掩码表，以向不同的分组转发

    - CIDR(classless interdomain routing)无类域间路由
    基本思想是分配IP地址时不再以类别分配，而是以地址块的形式(按需分配)
    根据需求分配网络位，避免地址浪费，缓解了IP地址枯竭的趋势

    - 路由聚合
    只有连续的块地址才能聚合成一个超网
    子网分配的逆过程

    - NAT(network address translation)私有IP和公有IP的转换
    - PAT(port address translation)将多个私有IP映射到一个公有IP的不同端口
    思路差不多，私网访问公网时转化为合法的global地址
    NAT能维持一个地址转换表，在数据到来时转发出去
    NAT转换了数据报文的端口地址
    NAT节约了公用IP数量，提供了灵活性和保密性，但增加了网络延迟，影响了部分协议和应用

    - ICMP(internet control message protocol)互联网控制消息协议
    ICMP用来向源(通常)报告IP分组的丢包、拥塞、延迟、抖动等
    ICMP也用于测试网络：ping命令，tracert命令

    - ARP(address resolution protocol)地址解析协议
    找到一个给定IP地址所对应的MAC地址
    ARP表 -- IP地址到MAC地址的映射表
    为了减少ARP请求的次数，每个设备都有ARP表，包括路由器
    dos 采用 arp -a 查看arp表信息; arp -d IP 删除记录; arp -s IP 添加记录

拥塞控制

    - 措施：增加资源或者降低负载
    抑制分组 路由器向源发一个抑制分组，源以一定百分比降低流量
    逐跳抑制分组 沿途路由均减少流量
    载荷脱落 直接丢弃分组
    随机早期检验random early detact 在队列长度超过阈值之前采取措施

    - 流量整形：调整数据传输平均速率，控制突发，较少拥塞
    漏桶算法 匀速，每一个tick允许固定数量发包、桶满丢弃分组
    令牌桶算法 允许加快到某种程度
      令牌桶中有令牌(token)，并以一定速率注入令牌
      分组要发送时必须取得令牌
      令牌桶允许积累令牌，最多可积累n个令牌(令牌桶容量)

### 传输层
传输层是整个TCP/IP协议的核心
传输层提供的是可靠的、高效的数据传输

UDP协议

    UDP是一个无连接的服务，在传输过程中无需建立连接
    很多C/S应用如DNS会发送一个UDP请求
    不提供差错检测和可靠传输，但是简洁高效
    头格式：源端口 + 目的端口 + 总长度(包含data) + 校验和 = 4Bytes

TCP数据段结构

    Source Port + Destination Port +
    Sequence Number +
    Acknowledgement Number +
    TCP header length + ... + URG + ACK + PSH + RST + SYN + FIN + 
    Window size +
    Checksum + Urgent Pointer +
    Options(0 or more 32bits) +
    Data

段头标记：

    URG: Urgent 紧急数据，即使窗口为0
    ACK: 确认号有效/无效
    PSH: push,不需缓存
    RST: 重置连接
    SYN: 连接建立
    FIN: 释放连接

TCP三次握手的建立

    Host1 SYN=1, ACK=0, seq=x
    Host2 SYN=1, ACK=1, seq=y, ack=x+1
    Host1 SYN=0, ACK=1, seq=x+1, ack=y+1

 TCP连接释放

    Host1 FIN=1
    Host2 ACK=1
    Host1收到后释放连接
    Host2 FIN=1
    Host1 ACK=1
    Host2收到后释放连接
    为了避免两军对垒问题，挥手需要四次
    TCP协议是全双工的

杀死半开放连接

    如果一定时间内没有TPDU到达，自动释放
    如果这样，传输实体在发送一个TPDU时必须启动一个定时器，如果定时器超期，将发送一个哑TPDU，以免被断掉

TCP流控和拥塞控制

    - TCP是全双工传输，通过window size进行流控
    发送方采用Nagle's algorithm, 尽量不发送数据含量小的数据段，缓存应用层的数据，达到一定量再发送。
    接收方采用Clark's algorithm,不请求对方发送短数据段，延迟窗口变更信息，使接收缓冲区足够大。

    - 网络层也可以管理拥塞，但大多数繁重的任务由TCP完成，解决方案为减慢数据率
    接收者窗口反映目前窗口的容量，容易控制
    拥塞窗口反映目前网络容量，难于控制
    采用慢启动算法，速率先指数增长，到达阈值的一半以上后线性增大

TCP和UDP

    TCP
    可靠的传输方式
    提供较好的流控
    可让应用程序简单化，程序员不必进行错误检查、修正工作

    UDP 
    降低对计算机资源的需求
    本身提供了数据完整性的检测
    传递的并非关键性数据
    一对多方式，必须使用UDP
